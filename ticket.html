<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üßæ Tu Pedido - CUMPLEA√ëOS LOIS</title>
<style>
body {
  font-family:'Segoe UI',sans-serif;
  background: #fff3e0;
  margin:0;
  padding:20px;
  text-align:center;
}

.card {
  max-width:450px;
  background:white;
  margin:auto;
  padding:20px;
  border-radius:18px;
  box-shadow:0 6px 20px rgba(0,0,0,0.2);
  transition:0.3s all;
}
.card.entregado {
  border:4px solid #4CAF50;
  box-shadow:0 8px 25px rgba(0,0,0,0.25);
  transform: scale(0.97); /* se encoge suavemente */
}

h2 { margin-top:0; color:#d2691e; }

#info { font-weight:bold; margin-bottom:15px; font-size:1.2em; }

.producto {
  background:#fff8e1;
  border-radius:12px;
  padding:12px;
  margin-bottom:15px;
  text-align:left;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  transition:0.3s transform;
}
.producto:hover { transform:scale(1.02); }

.producto h4 { margin:0 0 8px; }

.tower { display:flex; flex-direction:column-reverse; align-items:center; margin:8px 0; }

.layer {
  width:90%;
  height:36px;
  margin:4px 0;
  border-radius:8px;
  line-height:36px;
  color:white;
  font-weight:bold;
  text-align:center;
  text-shadow:0 1px 2px rgba(0,0,0,0.3);
}

.estado { font-weight:bold; margin:6px 0; }

.progress-container {
  background:#ddd;
  border-radius:25px;
  height:18px;
  overflow:hidden;
  margin:6px 0;
}

.progress-bar {
  height:100%;
  width:0%;
  border-radius:25px;
  transition: width 0.8s ease, background 0.8s ease;
}

.stars { margin:15px 0; }

.star {
  font-size:36px;
  color:#ccc;
  cursor:pointer;
  margin:0 3px;
  transition:color 0.3s;
}
.star.selected { color:#FFD700; }

button {
  margin-top:15px;
  background:#f44336;
  color:white;
  padding:12px;
  border:none;
  border-radius:12px;
  width:100%;
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
}
button:hover { opacity:0.85; }
</style>
</head>
<body>

<div class="card" id="card">
  <h2>üéâ CUMPLEA√ëOS LOIS üéâ</h2>
  <div id="info"></div>
  <div id="productos"></div>
  <div class="stars" id="stars"></div>
  <button onclick="avisar()">‚ö†Ô∏è No me lo han entregado</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCUtGv322RpaHehADB7BqHEkOjMFV2cEoc",
  authDomain: "gofres-tortitas.firebaseapp.com",
  projectId: "gofres-tortitas",
  storageBucket: "gofres-tortitas.firebasestorage.app",
  messagingSenderId: "840337514642",
  appId: "1:840337514642:web:3986826058b711131e464b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const id = new URLSearchParams(window.location.search).get("id");
const cardEl = document.getElementById("card");
const infoEl = document.getElementById("info");
const productosEl = document.getElementById("productos");
const starsEl = document.getElementById("stars");

const colors = {
  "Gofre":"#d2691e",
  "Tortita":"#f4c430",
  "Nocilla Blanca":"#FFF3B0",
  "Nocilla Normal":"#4E342E",
  "KitKat":"#C62828",
  "Oreo":"#263238"
};

function todosEntregados(productos){
  return productos.every(p=>p.estado==="ENTREGADO");
}

function dibujarProductos(productos){
  productosEl.innerHTML = "";
  productos.forEach(p=>{
    const box = document.createElement("div");
    box.className="producto";

    const titulo = document.createElement("h4");
    titulo.innerText = `${p.tipo} ¬∑ ${p.nombre}`;
    box.appendChild(titulo);

    const tower = document.createElement("div");
    tower.className="tower";
    p.capas.forEach(c=>{
      const layer = document.createElement("div");
      layer.className="layer";
      layer.style.background = colors[c] || "#888";
      layer.textContent = c;
      tower.appendChild(layer);
    });
    box.appendChild(tower);

    const estado = document.createElement("div");
    estado.className="estado";
    estado.innerText = "Estado: " + p.estado;
    box.appendChild(estado);

    const progressContainer = document.createElement("div");
    progressContainer.className="progress-container";

    const progressBar = document.createElement("div");
    progressBar.className="progress-bar";

    const width = {RECIBIDO:25, PREPARANDO:50, ENTREGANDO:75, ENTREGADO:100}[p.estado]||0;
    const color = {RECIBIDO:"#2196F3", PREPARANDO:"#FFC107", ENTREGANDO:"#FF9800", ENTREGADO:"#4CAF50"}[p.estado]||"#888";

    progressBar.style.background = color;
    progressBar.style.width = "0%"; // inicia en 0

    progressContainer.appendChild(progressBar);
    box.appendChild(progressContainer);
    productosEl.appendChild(box);

    // Animaci√≥n suave
    setTimeout(()=>{ progressBar.style.width = width + "%"; }, 50);
  });
}

function crearEstrellas(){
  starsEl.innerHTML = "";
  for(let i=1;i<=5;i++){
    const s = document.createElement("span");
    s.className="star";
    s.innerHTML="‚òÖ";
    s.onclick = ()=> {
      db.collection("pedidos").doc(id).update({nota:i}).then(()=>{
        alert("¬°Gracias por tu valoraci√≥n!");
        window.location="index.html";
      });
    };
    starsEl.appendChild(s);
  }
}

db.collection("pedidos").doc(id).onSnapshot(doc=>{
  const data = doc.data();
  if(!data) return;

  infoEl.innerText = data.nombre;

  const productos = data.productos || [{
    tipo: data.tipo,
    nombre: "√önico",
    capas: data.capas,
    estado: data.estado || "RECIBIDO"
  }];

  dibujarProductos(productos);

  if(todosEntregados(productos)){
    cardEl.classList.add("entregado");
  } else {
    cardEl.classList.remove("entregado");
  }

  if(todosEntregados(productos) && !data.nota){
    crearEstrellas();
  } else {
    starsEl.innerHTML = "";
  }
});

function avisar(){
  db.collection("pedidos").doc(id).update({aviso:true}).then(()=>{
    alert("Aviso enviado al admin");
  });
}
</script>

</body>
</html>
